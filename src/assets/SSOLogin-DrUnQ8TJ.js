import{au as x,d as H,a2 as J,u as N,r as L,a4 as b,h as Q,a as n,as as R,a5 as X,ae as A,c as m,o as p,j as l,f as B,s as i,O as D,X as E,x as w,a9 as G,b_ as K,F as M,i as P,C as W,ac as Y,t as Z,H as $,Q as I,a6 as ee}from"./index-DwcZmOlQ.js";import{u as se,L as T,_ as ae}from"./LoginFormTitle.vue_vue_type_script_setup_true_lang-CkqoI9Xw.js";const te={class:"form-cont"},oe={key:0},re={key:1},ne=H({name:"SSOLogin",__name:"SSOLogin",setup(le){const c=J(),{currentRoute:C}=N(),{getLoginState:U,setLoginState:V}=se(),k=L({name:"",logo:""}),a=b({responseType:"",clientId:"",redirectUri:"",state:"",scopes:[]}),z=Q(()=>n(U)===T.SSO),u=b({scopes:[]}),d=L(!1),F=async()=>{if(c.query.client_id===void 0)return;if(a.responseType=c.query.response_type,a.clientId=c.query.client_id,a.redirectUri=c.query.redirect_uri,a.state=c.query.state,c.query.scope&&(a.scopes=c.query.scope.split(" ")),a.scopes.length>0){const s=await q(!0,a.scopes,[]);if(s)return void(location.href=s)}const t=await(e=a.clientId,x.get({url:"/system/oauth2/authorize?clientId="+e}));var e;let o;if(k.value=t.client,a.scopes.length>0){o=[];for(const s of t.scopes)a.scopes.indexOf(s.key)>=0&&o.push(s)}else{o=t.scopes;for(const s of o)a.scopes.push(s.key)}for(const s of o)s.value&&u.scopes.push(s.key)},O=async t=>{let e,o;t?(e=u.scopes,o=a.scopes.filter(s=>e.indexOf(s)===-1)):(e=[],o=a.scopes),d.value=!0;try{const s=await q(!1,e,o);if(!s)return;location.href=s}finally{d.value=!1}},q=(t,e,o)=>((s,_,v,f,y,g,r)=>{const h={};for(const S of g)h[S]=!0;for(const S of r)h[S]=!1;return x.post({url:"/system/oauth2/authorize",headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{response_type:s,client_id:_,redirect_uri:v,state:f,auto_approve:y,scope:JSON.stringify(h)}})})(a.responseType,a.clientId,a.redirectUri,a.state,t,e,o),j=t=>{switch(t){case"user.read":return"\u8BBF\u95EE\u4F60\u7684\u4E2A\u4EBA\u4FE1\u606F";case"user.write":return"\u4FEE\u6539\u4F60\u7684\u4E2A\u4EBA\u4FE1\u606F";default:return t}};return R(()=>C.value,t=>{t.name==="SSOLogin"&&(V(T.SSO),F())},{immediate:!0}),(t,e)=>{const o=D,s=E,_=Y,v=K,f=G,y=$,g=ee;return X((p(),m("div",te,[l(ae,{style:{width:"100%"}}),l(s,{class:"form",style:{float:"none"},value:"uname"},{default:i(()=>[l(o,{label:n(k).name,name:"uname"},null,8,["label"])]),_:1}),B("div",null,[l(g,{model:n(u),class:"login-form"},{default:i(()=>[e[4]||(e[4]=w(" \u6B64\u7B2C\u4E09\u65B9\u5E94\u7528\u8BF7\u6C42\u83B7\u5F97\u4EE5\u4E0B\u6743\u9650\uFF1A ")),l(f,{prop:"scopes"},{default:i(()=>[l(v,{modelValue:n(u).scopes,"onUpdate:modelValue":e[0]||(e[0]=r=>n(u).scopes=r)},{default:i(()=>[(p(!0),m(M,null,P(n(a).scopes,r=>(p(),W(_,{key:r,value:r,style:{display:"block","margin-bottom":"-10px"}},{default:i(()=>[w(Z(j(r)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(f,{class:"w-1/1"},{default:i(()=>[l(y,{loading:n(d),class:"w-6/10",type:"primary",onClick:e[1]||(e[1]=I(r=>O(!0),["prevent"]))},{default:i(()=>[n(d)?(p(),m("span",re,"\u6388 \u6743 \u4E2D...")):(p(),m("span",oe,"\u540C\u610F\u6388\u6743"))]),_:1},8,["loading"]),l(y,{class:"w-3/10",onClick:e[2]||(e[2]=I(r=>O(!1),["prevent"]))},{default:i(()=>e[3]||(e[3]=[w("\u62D2\u7EDD")])),_:1})]),_:1})]),_:1},8,["model"])])],512)),[[A,n(z)]])}}});export{ne as default};
